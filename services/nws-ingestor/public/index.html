<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI-STORMS Operator</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; background: #0f0f12; color: #e4e4e7; }
    h1 { font-size: 1.25rem; margin: 0 0 1rem 0; }
    nav { margin-bottom: 1rem; }
    nav a { color: #a1a1aa; margin-right: 1rem; text-decoration: none; }
    nav a:hover, nav a.active { color: #fff; }
    .event-link { color: #60a5fa; text-decoration: none; }
    .event-link:hover { text-decoration: underline; }
    .events-cell { max-width: 280px; }
    section { display: none; }
    section.active { display: block; }
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #27272a; }
    th { color: #71717a; font-weight: 600; }
    tr:hover { background: #18181b; }
    button, .btn { background: #3f3f46; color: #fff; border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem; }
    button:hover, .btn:hover { background: #52525b; }
    button.primary { background: #2563eb; }
    button.primary:hover { background: #3b82f6; }
    input, select { background: #27272a; border: 1px solid #3f3f46; color: #e4e4e7; padding: 0.5rem; border-radius: 6px; margin-right: 0.5rem; }
    .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-right: 0.25rem; }
    .badge.hail { background: #fef3c7; color: #92400e; }
    .badge.wind { background: #dbeafe; color: #1e40af; }
    .badge.freeze { background: #e0e7ff; color: #3730a3; }
    .badge.class { background: #3f3f46; color: #a1a1aa; font-size: 0.7rem; }
    .badge.geom-missing { background: #7f1d1d; color: #fecaca; }
    .tabs { margin-bottom: 0.75rem; }
    .tabs button { margin-right: 0.5rem; padding: 0.4rem 0.75rem; border-radius: 6px; background: #27272a; color: #a1a1aa; border: 1px solid #3f3f46; cursor: pointer; }
    .tabs button.active { background: #3f3f46; color: #fff; }
    .tabs button:hover { background: #3f3f46; color: #e4e4e7; }
    .row-actions button { margin-right: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem; }
    .sort-mode select { min-width: 160px; }
    .breadcrumb { color: #a1a1aa; font-size: 0.875rem; margin-bottom: 0.5rem; }
    .breadcrumb a { color: #60a5fa; text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }
    .state-chip { display: inline-block; padding: 0.2rem 0.5rem; margin: 0.1rem; border-radius: 4px; background: #27272a; color: #60a5fa; cursor: pointer; font-size: 0.8rem; text-decoration: none; }
    .state-chip:hover { background: #3f3f46; color: #fff; }
    th.sortable { cursor: pointer; user-select: none; white-space: nowrap; }
    th.sortable:hover { color: #fff; }
    .sort-indicator { margin-left: 0.25rem; opacity: 0.8; }
    .badge.bucket-small { background: #14532d; color: #bbf7d0; }
    .badge.bucket-medium { background: #1e40af; color: #93c5fd; }
    .badge.bucket-large { background: #7c2d12; color: #fed7aa; }
    .badge.bucket-massive { background: #4c1d95; color: #e9d5ff; }
    .filter-toggles label { margin-right: 0.75rem; }
    .copy-block { font-family: monospace; font-size: 0.75rem; white-space: pre-wrap; background: #18181b; padding: 1rem; border-radius: 6px; margin: 1rem 0; max-height: 300px; overflow: auto; }
    .alert { padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0; }
    .alert.success { background: #14532d; color: #bbf7d0; }
    .alert.error { background: #7f1d1d; color: #fecaca; }
    .drawer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; }
    .drawer-overlay.open { display: block; }
    .drawer-panel { position: fixed; top: 0; right: 0; width: min(480px, 100vw); height: 100vh; background: #18181b; border-left: 1px solid #27272a; z-index: 101; display: flex; flex-direction: column; box-shadow: -4px 0 20px rgba(0,0,0,0.3); }
    .drawer-header { padding: 1rem; border-bottom: 1px solid #27272a; display: flex; justify-content: space-between; align-items: center; }
    .drawer-header h2 { margin: 0; font-size: 1.1rem; }
    .drawer-tabs { display: flex; gap: 0.25rem; padding: 0.5rem 1rem 0; border-bottom: 1px solid #27272a; flex-shrink: 0; }
    .drawer-tabs button { padding: 0.4rem 0.75rem; border: none; background: transparent; color: #a1a1aa; cursor: pointer; font-size: 0.875rem; border-radius: 6px; }
    .drawer-tabs button.active { background: #3f3f46; color: #fff; }
    .drawer-body { flex: 1; overflow: auto; padding: 1rem; }
    .drawer-body .tab-pane { display: none; }
    .drawer-body .tab-pane.active { display: block; }
    .summary-tiles { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
    .summary-tile { background: #27272a; padding: 0.75rem; border-radius: 6px; font-size: 0.875rem; }
    .summary-tile .value { font-weight: 600; color: #fff; }
    .places-table, .drawer-alerts-table { font-size: 0.8rem; width: 100%; }
    .confidence-high { color: #22c55e; }
    .confidence-medium { color: #eab308; }
    .confidence-low { color: #71717a; }
    .triage-pill { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
    .triage-pill.actionable { background: #dc2626; color: #fff; }
    .triage-pill.monitoring { background: #52525b; color: #e4e4e7; }
    .triage-pill.sent_manual { background: #16a34a; color: #fff; }
    .triage-pill.suppressed { background: #3f3f46; color: #a1a1aa; }
    .triage-pill.new { background: #27272a; color: #a1a1aa; }
    .lsr-status-pill { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
    .lsr-status-pill.none { background: #27272a; color: #71717a; }
    .lsr-status-pill.awaiting { background: #78350f; color: #fde68a; }
    .lsr-status-pill.matched { background: #14532d; color: #bbf7d0; }
    .lsr-status-pill.expired { background: #3f3f46; color: #a1a1aa; }
    .map-layout { display: grid; grid-template-columns: 280px 1fr; gap: 0; min-height: 75vh; }
    .map-left { background: #18181b; border-right: 1px solid #27272a; padding: 1rem; overflow: auto; }
    .map-left label { display: block; margin-top: 0.5rem; font-size: 0.875rem; }
    .map-left input[type="text"], .map-left select { width: 100%; margin-top: 0.25rem; }
    #map-container { min-height: 400px; width: 100%; }
    .map-disclaimer { font-size: 0.75rem; color: #71717a; margin-top: 0.5rem; }
    .leaflet-popup-content { margin: 0.5rem; font-size: 0.875rem; max-width: 360px; }
    .map-popup-headline { display: block; font-weight: normal; color: #a1a1aa; font-size: 0.8rem; margin: 0.2rem 0; }
    .map-polygon-tooltip { white-space: normal; max-width: 320px; font-size: 0.8rem; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
</head>
<body>
  <h1>AI-STORMS Operator</h1>
  <div id="login-section" style="display:none;">
    <p>Sign in to continue.</p>
    <input type="email" id="login-email" placeholder="Email" />
    <input type="password" id="login-password" placeholder="Password" />
    <button id="login-btn" class="primary">Sign in</button>
    <span id="login-error" class="alert error" style="display:none; margin-left: 0.5rem;"></span>
  </div>
  <nav id="nav" style="display:none;">
    <a href="#" data-page="dashboard" class="active">Dashboard</a>
    <a href="#" data-page="map">Map</a>
    <a href="#" data-page="outbox">Outbox</a>
    <button id="logout-btn">Logout</button>
  </nav>

  <section id="dashboard" class="active">
    <p>
      <button id="run-once-btn" class="primary" type="button">Run ingest once</button>
      <span id="run-once-status"></span>
    </p>
    <div class="breadcrumb" id="breadcrumb">All Alerts</div>
    <div class="sort-mode" style="margin-bottom: 0.5rem;">
      <label>Sort mode:</label>
      <select id="sort-mode">
        <option value="action" selected>Action Priority</option>
        <option value="work_queue">My Work Queue</option>
        <option value="damage">Confirmed Damage</option>
        <option value="tight">Tight Impact Zones</option>
        <option value="expires">Expiring Soon</option>
        <option value="broad">Broad Systems</option>
      </select>
      <button type="button" id="sort-reset-preset" style="margin-left: 0.5rem;">Reset to preset</button>
    </div>
    <div class="filter-toggles" style="margin-bottom: 0.5rem;">
      <label><input type="checkbox" id="filter-warnings-only" /> Warnings only</label>
      <label><input type="checkbox" id="filter-interesting-only" /> Interesting only</label>
      <label><input type="checkbox" id="filter-lsr-only" /> LSR only</label>
      <label><input type="checkbox" id="filter-hide-geom-missing" /> Hide GEOM MISSING</label>
      <label><input type="checkbox" id="filter-active" /> Active only</label>
      <label><input type="checkbox" id="filter-since-last-ingest" checked title="Only alerts from last Run ingest once (testing)" /> Only from last ingest run</label>
      <input type="number" id="filter-max-zip-count" placeholder="Max ZIPs" style="width:80px" title="max_zip_count" />
      <input type="number" id="filter-max-area" placeholder="Max area (sq mi)" style="width:100px" title="max_area_sq_miles" />
      <input type="text" id="filter-state" placeholder="State" style="width:60px" />
      <label>Triage:</label>
      <select id="filter-triage" style="width:120px;">
        <option value="">All</option>
        <option value="actionable">Actionable</option>
        <option value="monitoring">Monitoring</option>
        <option value="sent_manual">Sent (Manual)</option>
        <option value="suppressed">Suppressed</option>
        <option value="new">New</option>
      </select>
      <button type="button" id="filter-clear-state">Clear state</button>
      <button id="filter-apply">Apply</button>
    </div>
    <table id="alerts-table">
      <thead><tr>
        <th class="sortable" data-sort="event">Event <span class="sort-indicator"></span></th>
        <th>States</th>
        <th class="sortable" data-sort="zip_count">ZIPs <span class="sort-indicator"></span></th>
        <th>Size</th>
        <th>Geom</th>
        <th class="sortable" data-sort="area_sq_miles">Area <span class="sort-indicator"></span></th>
        <th class="sortable" data-sort="zip_density">Density <span class="sort-indicator"></span></th>
        <th class="sortable" data-sort="expires">Expires In <span class="sort-indicator"></span></th>
        <th class="sortable" data-sort="lsr_match_count">LSR <span class="sort-indicator"></span></th>
        <th>LSR Status</th>
        <th class="sortable" data-sort="damage_score">Score <span class="sort-indicator"></span></th>
        <th>Triage</th>
        <th>Badges</th>
        <th>Actions</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="detail">
    <p><a href="#" id="detail-back">← Back to Dashboard</a></p>
    <div id="detail-content"></div>
    <div id="detail-lsr-status" style="margin: 1rem 0; font-size: 0.875rem;"></div>
    <div id="detail-triage-actions" style="margin: 1rem 0;"></div>
    <p><button type="button" id="detail-recheck-lsr-btn">Recheck LSR now</button> <button type="button" id="detail-show-audit-btn">Show audit (last 20)</button></p>
    <div id="detail-audit" style="display:none; margin: 1rem 0; font-size: 0.8rem;"></div>
    <p>
      <button id="copy-zips-lsr-btn" class="primary">Copy ZIPs + LSR Summary</button>
      <a id="download-csv-btn" class="btn" href="#" download="zips.csv">Download CSV</a>
      <button id="queue-delivery-btn">Queue delivery</button>
    </p>
    <div id="detail-message"></div>
  </section>

  <section id="map">
    <div class="map-layout">
      <div class="map-left">
        <p><strong>Filters</strong></p>
        <label>States (comma, e.g. TX,OK)</label>
        <input type="text" id="map-states" placeholder="TX, OK" />
        <label><input type="checkbox" id="map-warnings-only" /> Warnings only</label>
        <label><input type="checkbox" id="map-interesting-only" /> Interesting only</label>
        <label>Min score (0–100)</label>
        <input type="number" id="map-min-score" min="0" max="100" value="0" style="width:80px" />
        <label>Since (hours)</label>
        <input type="number" id="map-since-hours" min="1" value="48" style="width:80px" />
        <label><input type="checkbox" id="map-since-last-ingest" checked title="Match dashboard: only alerts from last Run ingest once" /> Only from last ingest run</label>
        <label><input type="checkbox" id="map-prefer-polygons" /> Prefer polygons (hide ZIP proxy where polygon exists)</label>
        <p style="margin-top:1rem;"><strong>Layers</strong></p>
        <label><input type="checkbox" id="map-layer-base" checked /> Base (OSM)</label>
        <label><input type="checkbox" id="map-layer-radar" /> Radar (WMS)</label>
        <label><input type="number" id="map-radar-opacity" min="0" max="100" value="70" style="width:60px" /> % opacity</label>
        <label><input type="checkbox" id="map-layer-alerts" checked /> Alerts (polygons)</label>
        <label><input type="checkbox" id="map-layer-zips" checked /> ZIP Coverage Proxy</label>
        <p id="map-zip-disclaimer" class="map-disclaimer">ZIP Coverage Proxy: derived from impacted ZIP list, not official alert polygon.</p>
        <label><input type="checkbox" id="map-layer-lsr" disabled /> LSR Points (future)</label>
        <p style="margin-top:1rem;"><strong>Radar time</strong></p>
        <div id="map-radar-time-ui" style="display:none;">
          <span id="map-radar-time-label">—</span>
          <button type="button" id="map-radar-play" title="Play">▶</button>
          <button type="button" id="map-radar-pause" title="Pause" style="display:none;">⏸</button>
          <label>Speed: <select id="map-radar-speed"><option value="0.5">0.5×</option><option value="1" selected>1×</option><option value="2">2×</option></select></label>
        </div>
        <p id="map-radar-no-time" class="map-disclaimer" style="display:none;">Radar time not supported by WMS.</p>
        <button type="button" id="map-apply">Apply</button>
        <p id="map-hint-no-polygons" class="map-disclaimer" style="display:none; margin-top:0.5rem;">No alert polygons in this run (ZIP layer shows coverage).</p>
        <p id="map-hint-no-data" class="map-disclaimer" style="display:none; margin-top:0.5rem;">No events on map. Run &quot;Run ingest once&quot; on Dashboard, then click Apply. If using &quot;Only from last ingest run&quot;, run ingest first. Ensure <code>npm run migrate</code> has been run (zcta5_centroids for ZIP points).</p>
        <p id="map-error" class="alert error" style="display:none; margin-top:0.5rem;"></p>
      </div>
      <div id="map-container"></div>
    </div>
  </section>

  <section id="outbox">
    <table id="outbox-table">
      <thead><tr><th>Created</th><th>Alert ID</th><th>Destination</th><th>Status</th><th>Event key</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <div id="state-drawer-overlay" class="drawer-overlay" aria-hidden="true"></div>
  <div id="state-drawer-panel" class="drawer-panel" aria-hidden="true" style="display:none;">
    <div class="drawer-header">
      <h2 id="drawer-title">State: —</h2>
      <button type="button" id="drawer-close" aria-label="Close drawer">×</button>
    </div>
    <div class="drawer-tabs">
      <button type="button" data-drawer-tab="overview">Overview</button>
      <button type="button" data-drawer-tab="alerts">Alerts</button>
      <button type="button" data-drawer-tab="places">Places (Cities) v1</button>
      <button type="button" data-drawer-tab="outbox">Outbox (State)</button>
    </div>
    <div class="drawer-body">
      <div id="drawer-tab-overview" class="tab-pane">
        <div id="drawer-summary-tiles" class="summary-tiles"></div>
        <p><strong>Top events</strong></p>
        <ul id="drawer-top-events"></ul>
        <p><strong>Top alerts by score</strong></p>
        <ul id="drawer-top-alerts"></ul>
        <p style="margin-top:1rem;"><strong>Client Territory</strong> <span class="confidence-low">(optional — not configured)</span></p>
      </div>
      <div id="drawer-tab-alerts" class="tab-pane">
        <table class="drawer-alerts-table"><thead><tr><th>Event</th><th>Class</th><th>ZIPs</th><th>Geom</th><th>Expires</th><th>LSR</th><th>Score</th><th></th></tr></thead><tbody id="drawer-alerts-tbody"></tbody></table>
      </div>
      <div id="drawer-tab-places" class="tab-pane">
        <p><strong>LSR Places (higher signal)</strong></p>
        <table class="places-table"><thead><tr><th>Place</th><th>Obs</th><th>Hail max</th><th>Wind max</th><th>Tornado</th><th>Last seen</th><th>Confidence</th></tr></thead><tbody id="drawer-lsr-places-tbody"></tbody></table>
        <p style="margin-top:1rem;"><strong>Area Descriptions (Counties/Zones)</strong> <span class="confidence-low">— LOW CONFIDENCE (not city)</span></p>
        <ul id="drawer-area-desc-tokens"></ul>
      </div>
      <div id="drawer-tab-outbox" class="tab-pane">
        <table class="places-table"><thead><tr><th>Status</th><th>Created</th><th>Destination</th><th>ZIPs</th><th>Attempts</th><th>Last error</th><th></th></tr></thead><tbody id="drawer-outbox-tbody"></tbody></table>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="app.js"></script>
</body>
</html>
